<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>测试能否使用JSON读取动画</title>
<script type="text/javascript">
try{
    if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
        alert("您正在手机端访问本页面!")
    }else{
        alert("您正在电脑端访问本页面!");
    }
}catch(e){}
</script>

<style>
body {
	margin: 0;
	overflow: hidden;
}

canvas {
	width: 100%;
	height: 100%
}
#times{
position:absolute;
top:200px;
left:100px;
}
#ctrl {
				position: absolute;
				top: 200px;
				left: 0px;
				width: 200px;
				color: #555555;
				padding: 5px;
				font-family: Monospace;
				font-size: 13px;
				z-index:100;
			}
</style>
</head>
<body>
<div id="ctrl">
			Use controls to change morph target influences:<br/>
			放大  <input type="range" value="0" min="0" max="100" onchange="model.skeleton.bones[0].position.x = value/10;" /><br/>
			放大	  <input type="range" value="0" min="0" max="100" onchange="scalemodel(value/50,value/50,value/50);" /><br/>
			放大  <input type="range" value="0" min="0" max="100" onchange="model.skeleton.bones[0].scale.z = (value/100);" /><br/>
			<button onclick = "play = !play;">测试1</button>
			<button onclick = "model1.skeleton.pose();">测试2</button>
			<button onclick = 'anim();'>开始动画</button>
			<h1 id = 'times'>这是一个测试</h1>
			<script>
			function scalemodel(x,y,z)
			{
				for(var i = 1,size = model.skeleton.bones.length;i < size; i++)
					{
						model.skeleton.bones[i].scale.set(x,y,z);
					}
			}
			</script>
</div>
<div id = 'div1'>
<canvas id='canvas' width=window.innerWidth height=window.innerHeight>
你的浏览器不支持本应用
</canvas>
</div>


	<script src='js/dat.gui.js'>
	//GUI框架
	</script>
	<script src='js/three.js'>
	//three.js框架
	</script>
	<script src='js/stats.min.js'>
	//显示帧数
	</script>
	<script src='js/TrackballControls.js'>
	//鼠标控制
	</script>
	<script src='js/loaders/OBJLoader.js'>
	//用来加载obj模型
	</script>
	<script src='js/TransformControls.js'>
	//控制移动的框架
	</script>
	<script src = 'js/SkeletonHelper.js'>

	</script>
	<script src = 'js/AnimationMixer.js'>

	</script>
	<script type="text/javascript">
	//这里用来存放一些全局变量

	var winWidth, winHeight;		// 画板的大小
	var canvas, scene, camera;		// 画板 场景 相机
	var renderer, stats;			// 渲染器及帧数显示器
	var axes ;						// 坐标轴
	var clock, cameraControls;		// 时钟和轨迹球控制器
	var dtrectionalLight;			// 平行光线
	var gridHelper;					// 网格助手
	var objloader;					// objloader
	var delta;						// 用来获取时间
	var control;					// 测试移动插件
	var model1,model2,mixer,mixer2;		// 动画部分
	var helper;						// 显示骨骼的工具
	var action;						// 动作
	var play;						// 播放状态
	</script>
<script type="text/javascript">
function onWindowResize() //重置窗口大小
{
	camera.aspect = window.innerWidth / window.innerHeight;			// 重置相机比例
	camera.updateProjectionMatrix();								//

	renderer.setSize(window.innerWidth, window.innerHeight);		// 重置渲染的大小

	doucument.getElementById('canvas').width = window.innerWidth;
	doucument.getElementById('canvas').height = window.innerHeight;
}

function init()
{
	canvas=document.getElementById('canvas');					// 创建一个canvas
	scene = new THREE.Scene();									// 创建一个scene
	camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );	// 创建相机
	// 设置相机初始位置，使其正对着模型
	camera.position.z = 20/100;
	camera.position.x = 0;
	camera.position.y = 10/100;

	renderer = new THREE.WebGLRenderer({canvas:document.getElementById('canvas'),
		antialias:true,
		precision:THREE.highp });					//创建一个渲染器
	renderer.setSize( window.innerWidth, window.innerHeight );		//设置渲染器渲染范围
	renderer.setClearColor(0xEEEEEE);
	play = false;
}

function addstats()		// 添加状态显示模块，在init之后执行
{
	stats = new Stats();									// 新建一个状态显示器
	stats.setMode(0);										// 设置为默认显示fps
	// 设置stats的位置s
	stats.domElement.style.position = 'absolute';
	stats.domElement.style.left = '0px';
	stats.domElement.style.top	 = '0px';
	document.body.appendChild(stats.domElement);			// 添加到页面中
}

function addListener()		// 用来统一添加监听器
{
	window.addEventListener('resize', onWindowResize, false);	// 添加监听器，用来监听窗口变化
}

function addTrackball()		// 用来添加轨迹球控制器
{
	// TrackballControls 设置一个轨迹球操作器
	clock = new THREE.Clock();
	cameraControls = new THREE.TrackballControls(camera,renderer.domElement);			// 定义相机控制器
	cameraControls.target.set(0, 10/100, 0);								// 设置中心点坐标
	cameraControls.zoomSpeed = 1.0;								// 设置缩放速度
	// cameraControls.enable = false;
	cameraControls.rotateSpeed = 1.0;
	cameraControls.panSpeed = 1.0;
	//cameraControls.noPan = true;								// 不让移动
	cameraControls.dynamicDampingFactor = 0.5;					// 设置阻尼效果，可以改变鼠标拖动时操作的灵敏度
	//cameraControls.minDistance = 10.0;							// 设置最近距离，可以使相机不要过分的接近
	//cameraControls.maxDistance = 200.0;							// 设置最远距离，可以使相机不要过分的远离
}

function addLight()			// 添加光线
{
	directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
	directionalLight.position.set(1,1, 1);						// 设置光线方向
	//directionalLight.shadowCameraVisble = true;
	scene.add(directionalLight);
}

function addGrid()			// 添加网格
{
	var size = 10;
	var step = 0.5;
	gridHelper = new THREE.GridHelper(size, step);		// 添加一个网格助手
	scene.add(gridHelper);
}

function loadjson()			// 读取一个JSON模型
{
	var loader = new THREE.JSONLoader();

	loader.load('models/body.json', function (geometry, materials) {
	    model1 = new THREE.SkinnedMesh(
	    		geometry,
	    		new THREE.MeshLambertMaterial({color:0xaaaaaa,
	    			skinning:true
	    			}));
	    model1.scale.set(1,1,1);
	    scene.add(model1);
	    // alert("hh");
	    model1.visible = true;						// 测试能否导入骨架信息

	    helper = new THREE.SkeletonHelper( model1 );
		helper.material.linewidth = 10;
		helper.visible = true;
		scene.add( helper );

	});
	
	loader.load('models/eye.json', function (geometry, materials) {
	    model2 = new THREE.SkinnedMesh(
	    		geometry,
	    		new THREE.MeshLambertMaterial({
	    			color:0xff0000,
	    			skinning:true
	    			}));
	    model2.scale.set(1,1,1);
	    scene.add(model2);
	    // alert("hh");
	    model2.visible = true;						


	});
	
	
}

function anim()
{
	model2.bind(model1.skeleton,model2.matrixWorld);	// 尝试将眼睛和人绑定在同一个骨架上
	
	mixer = new THREE.AnimationMixer(model1);
	if(model1.geometry.animations[0] )
	{
		mixer.clipAction(model1.geometry.animations[0],model1).play();
	}	
// 	mixer2 = new THREE.AnimationMixer(model2);
// 	if(model1.geometry.animations[0] )
// 	{
// 		mixer2.clipAction(model1.geometry.animations[0],model2).play();
// 	}
}

function render()
{

	renderer.render( scene, camera );					// 渲染相机和场景
	stats.update();										// 更新
	if(play)
		{
			delta = clock.getDelta();							// 获取时间
			mixer.update(  0.01*delta );
			//mixer2.update(  0.01*delta );
			//document.getElementById('times').innerHTML = action.time;
			helper.update();
		}
	
}

function cameraCtrl()
{
	delta = clock.getDelta();							// 获取时间
	cameraControls.update(delta);						// 更新


}

function animation()			// 动画
{
	requestAnimationFrame( animation );					// 要求定时渲染
	render();
	cameraCtrl();										// 鼠标控制
}
</script>
<script type="text/javascript">
function main()
{
	init();					// 初始化窗口
	addListener()			// 添加监听器
	addstats();				// 添加状态显示
	addTrackball();			// 添加轨迹球控制器
	loadjson();				// 读取JSON模型
	addLight();				// 添加光线
	addGrid();				// 添加网格
	animation();			// 调用动画

}
main();						//为了更清晰的理清逻辑，建立一个main函数,在窗口打开后执行一次
</script>
</body>
</html>
